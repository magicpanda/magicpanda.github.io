import{t as e}from"./function-call-C-X9mcip.js";import{a as t,i as n,n as r,t as i}from"./_plugin-vue_export-helper-BGPu65u-.js";import{At as a,Dt as o,X as s,Y as c,at as l,ct as u,dt as d,it as f,jt as p,kt as m,ot as h,ut as g,wt as _,xt as v,yt as y}from"./index-Cx_W_gHZ.js";function b(e){if(typeof e==`string`){let t=e.trim();if(!/^-?\d+(\.\d+)?$/.test(t))return!1;e=parseFloat(t)}return typeof e==`number`&&!isNaN(e)&&isFinite(e)&&e>0}var x={class:`edit-page`},S={class:`content`},C={class:`form-buttons`},w=i({__name:`EditPage`,setup(i){let w=c(),T=s(),E=r(),D=a(!0),O=a(!1),k=a(!1),A=w.params.id,j=new Date(2e3,0,1),M=new Date,N=a([`2024`,`01`,`01`]),P=f(()=>E.getBookById(A)),F=f(()=>!P.value||!P.value.authors||P.value.authors.length===0?`未知作者`:P.value.authors.join(`, `)),I=m({collectionStatus:`on_shelf`,readingStatus:`unread`,bookType:``,purchaseDate:``,purchasePrice:``,purchaseSource:``}),L=()=>{if(P.value&&(I.collectionStatus=P.value.collectionStatus||`on_shelf`,I.readingStatus=P.value.readingStatus||`unread`,I.bookType=P.value.bookType||``,P.value.purchaseInfo&&(I.purchaseDate=P.value.purchaseInfo.date?R(P.value.purchaseInfo.date):``,I.purchasePrice=P.value.purchaseInfo.price?.toString()||``,I.purchaseSource=P.value.purchaseInfo.source||``,P.value.purchaseInfo.date))){let e=new Date(P.value.purchaseInfo.date);N.value=[e.getFullYear().toString(),(e.getMonth()+1).toString().padStart(2,`0`),e.getDate().toString().padStart(2,`0`)]}},R=e=>e?new Date(e).toLocaleDateString(`zh-CN`,{year:`numeric`,month:`2-digit`,day:`2-digit`}):``,z=e=>{let[t,n,r]=e;I.purchaseDate=`${t}-${n}-${r}`,k.value=!1},B=()=>{if(I.purchasePrice){let e=b(I.purchasePrice);if(!e.valid)return n(e.message),!1}return!0},V=async()=>{if(B()){O.value=!0;try{let e={collectionStatus:I.collectionStatus,readingStatus:I.readingStatus,bookType:I.bookType,updatedDate:new Date().toISOString()};I.purchaseDate||I.purchasePrice||I.purchaseSource?e.purchaseInfo={date:I.purchaseDate?new Date(I.purchaseDate).toISOString():null,price:I.purchasePrice?parseFloat(I.purchasePrice):null,source:I.purchaseSource||``}:e.purchaseInfo=null;let r=await E.updateBook(A,e);r.success?(t(`保存成功`),setTimeout(()=>{T.back()},500)):n(r.error||`保存失败`)}catch(e){console.error(`保存图书失败:`,e),n(`保存失败，请重试`)}finally{O.value=!1}}},H=()=>{U()?e({title:`确认退出`,message:`有未保存的更改，确定要退出吗？`,showCancelButton:!0,confirmButtonText:`退出`,cancelButtonText:`继续编辑`}).then(()=>{T.back()}).catch(()=>{}):T.back()},U=()=>{if(!P.value)return!1;if(I.collectionStatus!==P.value.collectionStatus||I.readingStatus!==P.value.readingStatus||I.bookType!==(P.value.bookType||``))return!0;let e=P.value.purchaseInfo?.date?R(P.value.purchaseInfo.date):``,t=P.value.purchaseInfo?.price?.toString()||``,n=P.value.purchaseInfo?.source||``;return I.purchaseDate!==e||I.purchasePrice!==t||I.purchaseSource!==n};return y(async()=>{if(E.books.length===0&&await E.loadBooks(),D.value=!1,!P.value){console.error(`Book not found:`,A);return}L()}),(e,t)=>{let n=_(`van-nav-bar`),r=_(`van-loading`),i=_(`van-button`),a=_(`van-empty`),s=_(`van-field`),c=_(`van-cell-group`),f=_(`van-radio`),m=_(`van-cell`),y=_(`van-radio-group`),b=_(`van-form`),w=_(`van-date-picker`),T=_(`van-popup`);return v(),u(`div`,x,[d(n,{title:`编辑图书`,"left-arrow":``,fixed:``,onClickLeft:H}),l(`div`,S,[D.value?(v(),h(r,{key:0,class:`loading`,size:`24px`,vertical:``},{default:o(()=>[...t[19]||=[g(` 正在加载... `,-1)]]),_:1})):P.value?(v(),h(b,{key:2,onSubmit:V},{default:o(()=>[d(c,{inset:``,title:`基本信息`},{default:o(()=>[d(s,{modelValue:P.value.title,"onUpdate:modelValue":t[0]||=e=>P.value.title=e,label:`书名`,readonly:``},null,8,[`modelValue`]),d(s,{modelValue:F.value,"onUpdate:modelValue":t[1]||=e=>F.value=e,label:`作者`,readonly:``},null,8,[`modelValue`]),d(s,{modelValue:P.value.isbn,"onUpdate:modelValue":t[2]||=e=>P.value.isbn=e,label:`ISBN`,readonly:``},null,8,[`modelValue`])]),_:1}),d(c,{inset:``,title:`藏书状态`},{default:o(()=>[d(y,{modelValue:I.collectionStatus,"onUpdate:modelValue":t[6]||=e=>I.collectionStatus=e},{default:o(()=>[d(c,{inset:``},{default:o(()=>[d(m,{title:`在架`,clickable:``,onClick:t[3]||=e=>I.collectionStatus=`on_shelf`},{"right-icon":o(()=>[d(f,{name:`on_shelf`})]),_:1}),d(m,{title:`借出`,clickable:``,onClick:t[4]||=e=>I.collectionStatus=`lent_out`},{"right-icon":o(()=>[d(f,{name:`lent_out`})]),_:1}),d(m,{title:`丢失`,clickable:``,onClick:t[5]||=e=>I.collectionStatus=`lost`},{"right-icon":o(()=>[d(f,{name:`lost`})]),_:1})]),_:1})]),_:1},8,[`modelValue`])]),_:1}),d(c,{inset:``,title:`阅读状态`},{default:o(()=>[d(y,{modelValue:I.readingStatus,"onUpdate:modelValue":t[10]||=e=>I.readingStatus=e},{default:o(()=>[d(c,{inset:``},{default:o(()=>[d(m,{title:`未读`,clickable:``,onClick:t[7]||=e=>I.readingStatus=`unread`},{"right-icon":o(()=>[d(f,{name:`unread`})]),_:1}),d(m,{title:`在读`,clickable:``,onClick:t[8]||=e=>I.readingStatus=`reading`},{"right-icon":o(()=>[d(f,{name:`reading`})]),_:1}),d(m,{title:`已读`,clickable:``,onClick:t[9]||=e=>I.readingStatus=`finished`},{"right-icon":o(()=>[d(f,{name:`finished`})]),_:1})]),_:1})]),_:1},8,[`modelValue`])]),_:1}),d(c,{inset:``,title:`图书类型`},{default:o(()=>[d(s,{modelValue:I.bookType,"onUpdate:modelValue":t[11]||=e=>I.bookType=e,label:`类型`,placeholder:`如：小说、技术、历史等`,clearable:``},null,8,[`modelValue`])]),_:1}),d(c,{inset:``,title:`购书信息（可选）`},{default:o(()=>[d(s,{modelValue:I.purchaseDate,"onUpdate:modelValue":t[12]||=e=>I.purchaseDate=e,label:`购买日期`,placeholder:`选择日期`,readonly:``,"is-link":``,onClick:t[13]||=e=>k.value=!0},null,8,[`modelValue`]),d(s,{modelValue:I.purchasePrice,"onUpdate:modelValue":t[14]||=e=>I.purchasePrice=e,label:`购买价格`,placeholder:`请输入价格`,type:`number`,clearable:``},{"left-icon":o(()=>[...t[21]||=[l(`span`,{style:{"margin-right":`4px`}},`¥`,-1)]]),_:1},8,[`modelValue`]),d(s,{modelValue:I.purchaseSource,"onUpdate:modelValue":t[15]||=e=>I.purchaseSource=e,label:`购买渠道`,placeholder:`如：京东、当当、实体书店等`,clearable:``},null,8,[`modelValue`])]),_:1}),l(`div`,C,[d(i,{type:`primary`,size:`large`,block:``,"native-type":`submit`,loading:O.value},{default:o(()=>[...t[22]||=[g(` 保存 `,-1)]]),_:1},8,[`loading`]),d(i,{size:`large`,block:``,onClick:H},{default:o(()=>[...t[23]||=[g(` 取消 `,-1)]]),_:1})])]),_:1})):(v(),h(a,{key:1,image:`error`,description:`未找到该图书`},{default:o(()=>[d(i,{type:`primary`,onClick:H},{default:o(()=>[...t[20]||=[g(`返回`,-1)]]),_:1})]),_:1}))]),d(T,{show:k.value,"onUpdate:show":t[18]||=e=>k.value=e,position:`bottom`},{default:o(()=>[d(w,{modelValue:N.value,"onUpdate:modelValue":t[16]||=e=>N.value=e,title:`选择日期`,"min-date":p(j),"max-date":p(M),onConfirm:z,onCancel:t[17]||=e=>k.value=!1},null,8,[`modelValue`,`min-date`,`max-date`])]),_:1},8,[`show`])])}}},[[`__scopeId`,`data-v-44be4262`]]);export{w as default};